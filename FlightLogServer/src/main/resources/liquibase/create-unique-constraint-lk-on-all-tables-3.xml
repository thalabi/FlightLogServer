<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog
	xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="
		http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd
		http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

    <changeSet id="create-unique-constraint-lk-on-all-tables-3" author="thalabi">

		<sql>
		<![CDATA[
		update flight_log fl1 
   		   set fl1.lk = (
				with fl2 as (
					select id, row_number() over(partition by flight_date order by flight_date) seq from flight_log
				) 
				select fl1.route_from||'|'||fl1.route_to||'|'||to_char(fl1.flight_date,'yyyy-MM-dd')||'|'||fl2.seq
					from fl2 where fl1.id = fl2.id)
		]]>         
		</sql>
        <addUniqueConstraint columnNames="lk" constraintName="flight_log_unique_lk" tableName="flight_log"/>
    
    </changeSet>
</databaseChangeLog>