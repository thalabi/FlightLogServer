<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
	xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="
		http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd
		http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">
    
    <changeSet id="create-view-oracle" author="Tarif Halabi">
	    <preConditions onFail="CONTINUE">
	        <dbms type="oracle" />
	    </preConditions>
        <comment>Create flight_log_totals_v</comment>

    	<createView viewName="flight_log_totals_v" replaceIfExists="true">
			<![CDATA[
with
last_flight_date_in_month as ( 
select distinct last_value(flight_date) over (partition by trunc(flight_date, 'month') order by trunc(flight_date, 'month')) as last_flight_date_in_month
   from flight_log
),
last_flight_date_and_id_in_month as (
select flight_date as last_flight_date_in_month, max(fl.id) as last_id_in_month from flight_log fl join last_flight_date_in_month lfdim on fl.flight_date = lfdim.last_flight_date_in_month group by flight_date
),
last_flight_date_in_year as (
 select distinct last_value(flight_date) over (partition by trunc(flight_date, 'year') order by trunc(flight_date, 'year')) as last_flight_date_in_year 
   from flight_log
),
last_flight_date_and_id_in_year as (
select flight_date as last_flight_date_in_year, max(fl.id) as last_id_in_year from flight_log fl join last_flight_date_in_year lfdiy on fl.flight_date = lfdiy.last_flight_date_in_year group by flight_date
)
	select id,flight_date,make_model,registration,pic,co_pilot,route_from,route_to,remarks,
	       day_dual,day_solo,night_dual,night_solo,
	       instrument_imc,instrument_simulated,instrument_flight_sim,instrument_no_ifr_appr,
	       x_country_day,x_country_night,tos_ldgs_day,tos_ldgs_night,
	       total_day_dual as to_date_day_dual,total_day_solo as to_date_day_solo,total_night_dual as to_date_night_dual,total_night_solo as to_date_night_solo,
	       total_instrument_imc as to_date_instrument_imc,total_instrument_simulated as to_date_instrument_simulated,total_instrument_flight_sim as to_date_instrument_flight_sim,total_instrument_no_ifr_appr as to_date_instrument_no_ifr_appr,
	       total_x_country_day as to_date_x_country_day,total_x_country_night as to_date_x_country_night,total_tos_ldgs_day as to_date_tos_ldgs_day,total_tos_ldgs_night as to_date_tos_ldgs_night,
	       total_to_date as to_date_total,
	       month_day_dual,month_day_solo,month_night_dual,month_night_solo,
	       month_instrument_imc,month_instrument_simulated,month_instrument_flight_sim,month_instrument_no_ifr_appr,
	       month_x_country_day,month_x_country_night,month_tos_ldgs_day,month_tos_ldgs_night,
	       month_total,
	       year_day_dual,year_day_solo,year_night_dual,year_night_solo,
	       year_instrument_imc,year_instrument_simulated,year_instrument_flight_sim,year_instrument_no_ifr_appr,
	       year_x_country_day,year_x_country_night,year_tos_ldgs_day,year_tos_ldgs_night,
	       year_total
	  from flight_log_running_total_v flrt
	       left join
		   (
			select lfdaiim.last_flight_date_in_month				month_flight_date,
			       lfdaiim.last_id_in_month				month_id,
				   flm.month					month,
			       flm.day_dual                 month_day_dual,
			       flm.day_solo                 month_day_solo,
				   flm.night_dual				month_night_dual,
				   flm.night_solo				month_night_solo,
			       flm.instrument_imc			month_instrument_imc,
			       flm.instrument_simulated		month_instrument_simulated,
			       flm.instrument_flight_sim	month_instrument_flight_sim,
			       flm.instrument_no_ifr_appr	month_instrument_no_ifr_appr,
			       flm.x_country_day			month_x_country_day,
			       flm.x_country_night			month_x_country_night,
			       flm.tos_ldgs_day				month_tos_ldgs_day,
			       flm.tos_ldgs_night			month_tos_ldgs_night,
				   flm.total_month				month_total
			  from flight_log_monthly_total_v flm join last_flight_date_and_id_in_month lfdaiim
			 on trunc(lfdaiim.last_flight_date_in_month,'month') = flm.month
		   ) flmt
		   on flrt.flight_date = flmt.month_flight_date and
		      flrt.id = flmt.month_id
		   left join
		   (
			select lfdaiiy.last_flight_date_in_year			   year_flight_date,
			       lfdaiiy.last_id_in_year			   year_id,
				   fly.year					   year,
			       fly.day_dual				   year_day_dual,
			       fly.day_solo				   year_day_solo,
				   fly.night_dual			   year_night_dual,
				   fly.night_solo			   year_night_solo,
			       fly.instrument_imc		   year_instrument_imc,
			       fly.instrument_simulated	   year_instrument_simulated,
			       fly.instrument_flight_sim   year_instrument_flight_sim,
			       fly.instrument_no_ifr_appr  year_instrument_no_ifr_appr,
			       fly.x_country_day		   year_x_country_day,
			       fly.x_country_night		   year_x_country_night,
			       fly.tos_ldgs_day			   year_tos_ldgs_day,
			       fly.tos_ldgs_night		   year_tos_ldgs_night,
				   fly.total_year			   year_total
			  from flight_log_yearly_total_v fly join last_flight_date_and_id_in_year lfdaiiy
			 on trunc(lfdaiiy.last_flight_date_in_year, 'year') = fly.year
		   ) flyt  
		   on flrt.flight_date = flyt.year_flight_date and
		      flrt.id = flyt.year_id
		   order by 1,2
 			]]>    
		</createView>

    </changeSet>
</databaseChangeLog>